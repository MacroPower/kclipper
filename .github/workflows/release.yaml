name: release

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to release
        required: true

jobs:
  goreleaser:
    name: goreleaser
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
      attestations: write
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"
          owner: "${{ github.repository_owner }}"
          repositories: |
            kclipper
            homebrew-tap
            nur-packages

      - name: Checkout
        uses: actions/checkout@v6
        with:
          token: "${{ steps.app-token.outputs.token }}"
          ref: ${{ github.event.inputs.tag != '' && format('refs/tags/{0}', github.event.inputs.tag) || github.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Determine tag
        id: tag
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if [ -n "$INPUT_TAG" ]; then
            echo "value=$INPUT_TAG" >> "$GITHUB_OUTPUT"
          else
            echo "value=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Release via Dagger
        uses: dagger/dagger-for-github@v8
        with:
          version: "0.19"
          verb: call
          args: >-
            release
            --github-token=env://GITHUB_TOKEN
            --registry-username="${{ github.actor }}"
            --registry-password=env://REGISTRY_PASSWORD
            --tag="${{ steps.tag.outputs.value }}"
            --cosign-key=env://COSIGN_KEY
            --cosign-password=env://COSIGN_PASSWORD
            --macos-sign-p12=env://MACOS_SIGN_P12
            --macos-sign-password=env://MACOS_SIGN_PASSWORD
            --macos-notary-key=env://MACOS_NOTARY_KEY
            --macos-notary-key-id=env://MACOS_NOTARY_KEY_ID
            --macos-notary-issuer-id=env://MACOS_NOTARY_ISSUER_ID
            export --path=./dist
        env:
          GITHUB_TOKEN: "${{ steps.app-token.outputs.token }}"
          REGISTRY_PASSWORD: "${{ secrets.GITHUB_TOKEN }}"
          COSIGN_KEY: "${{ secrets.COSIGN_KEY }}"
          COSIGN_PASSWORD: "${{ secrets.COSIGN_PASSWORD }}"
          MACOS_SIGN_P12: "${{ secrets.MACOS_SIGN_P12 }}"
          MACOS_SIGN_PASSWORD: "${{ secrets.MACOS_SIGN_PASSWORD }}"
          MACOS_NOTARY_KEY: "${{ secrets.MACOS_NOTARY_KEY }}"
          MACOS_NOTARY_KEY_ID: "${{ secrets.MACOS_NOTARY_KEY_ID }}"
          MACOS_NOTARY_ISSUER_ID: "${{ secrets.MACOS_NOTARY_ISSUER_ID }}"

      - name: Attest Build Provenance (checksums.txt)
        uses: actions/attest-build-provenance@v3
        with:
          subject-checksums: ./dist/checksums.txt

      - name: Attest Build Provenance (digests.txt)
        uses: actions/attest-build-provenance@v3
        with:
          subject-checksums: ./dist/digests.txt

  kcl-mod:
    name: kcl-mod
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.tag != '' && format('refs/tags/{0}', github.event.inputs.tag) || github.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Set up KCL
        run: wget -q https://kcl-lang.io/script/install-cli.sh -O - | /bin/bash

      - name: Login to GitHub Container Registry
        run: kcl registry login -u $GITHUB_ACTOR -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
        env:
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Publish KCL packages
        run: |
          # Get the tag version without the 'v' prefix
          VERSION=${GITHUB_REF#refs/tags/v}

          # Find all directories under modules
          for dir in ./modules/*/; do
            if [ -d "$dir" ]; then
              echo "Processing module: $dir"
              cd "$dir"

              if [ -f "kcl.mod" ]; then
                PKG_NAME=$(basename $dir)

                # Update the version in kcl.mod file
                sed -i "s/^version = .*/version = \"${VERSION}\"/" "kcl.mod"

                echo "Publishing module: $PKG_NAME"
                cat kcl.mod

                kcl mod push oci://ghcr.io/macropower/kclipper/$PKG_NAME
              fi
              cd -
            fi
          done
